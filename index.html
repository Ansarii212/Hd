<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>نظام تحضير الموظفين</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      background-color: #f7f7f7;
      padding: 20px;
      direction: rtl;
    }
    form, table {
      margin: auto;
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px #ccc;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 18px;
    }
    table {
      width: 90%;
      max-width: 800px;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 16px;
    }
    th {
      background-color: #eee;
    }
    .print-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
    }
    .print-btn:hover {
      background-color: #45a049;
    }
    #printPage {
      display: none;
    }
  </style>
</head>
<body>

<h2 id="registerTitle">تسجيل المدير</h2>
<form id="registerForm">
  <input type="text" id="managerName" placeholder="اسم المدير" required>
  <input type="text" id="schoolName" placeholder="اسم المدرسة" required>
  <input type="text" id="managerPhone" placeholder="رقم الجوال" required>
  <input type="password" id="managerPassword" placeholder="كلمة المرور" required>
  <button type="submit">تسجيل المدير</button>
</form>

<h2>تسجيل الدخول</h2>
<form id="loginForm">
  <input type="text" id="loginPhone" placeholder="رقم الجوال">
  <input type="password" id="loginPassword" placeholder="كلمة المرور">
  <button type="submit">دخول</button>
</form>

<button id="logoutBtn" style="display:none;">تسجيل الخروج</button>

<div id="managerPage" style="display:none;">
  <h2 id="schoolTitle"></h2>
  <h3>إضافة معلم جديد</h3>
  <form id="addTeacherForm">
    <input type="text" id="teacherName" placeholder="اسم المعلم">
    <input type="text" id="teacherPhone" placeholder="رقم جوال المعلم">
    <input type="password" id="teacherPassword" placeholder="كلمة المرور">
    <button type="submit">إضافة معلم</button>
  </form>

  <button id="openAttendanceTableBtn">فتح جدول الحضور</button>

  <div id="printPage">
    <h3>تقرير تحضير الموظفين</h3>
    <input type="date" id="dateFilter" onchange="loadAttendance()" />
    <table id="reportTable">
      <thead>
        <tr>
          <th>اسم المعلم</th>
          <th>الحضور</th>
          <th>الوقت</th>
          <th>التاريخ</th>
          <th>الإحداثيات</th>
          <th>المسافة (متر)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="print-btn" onclick="window.print()">طباعة التقرير</button>
  </div>
</div>

<div id="teacherPage" style="display:none;">
  <h2>مرحبًا <span id="teacherNameDisplay"></span></h2>
  <button id="markAttendance">تحضير الآن</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, get, child, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
    authDomain: "hamsa-6009e.firebaseapp.com",
    databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
    projectId: "hamsa-6009e",
    storageBucket: "hamsa-6009e.appspot.com",
    messagingSenderId: "998163671039",
    appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca",
    measurementId: "G-PD1QB8X0FE"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  const registerForm = document.getElementById("registerForm");
  const loginForm = document.getElementById("loginForm");
  const addTeacherForm = document.getElementById("addTeacherForm");
  const logoutBtn = document.getElementById("logoutBtn");

  let currentUserId = null;
  let schoolLocation = null;

  if (localStorage.getItem("managerRegistered") === "true") {
    registerForm.style.display = "none";
    document.getElementById("registerTitle").style.display = "none";
  }

  registerForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = managerName.value;
    const school = schoolName.value;
    const phone = managerPhone.value;
    const password = managerPassword.value;
    const email = phone + "@admin.com";

    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      createUserWithEmailAndPassword(auth, email, password).then(userCred => {
        const uid = userCred.user.uid;
        currentUserId = uid;
        schoolLocation = { lat, lng };

        set(ref(db, "managers/" + uid), {
          name, school, phone, lat, lng
        });

        localStorage.setItem("managerRegistered", "true");
        alert("تم تسجيل المدير بنجاح");
        registerForm.style.display = "none";
        document.getElementById("registerTitle").style.display = "none";
        loginForm.style.display = "block";
      });
    });
  });

  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const phone = loginPhone.value;
    const password = loginPassword.value;
    const email = phone + "@admin.com";

    signInWithEmailAndPassword(auth, email, password).then(cred => {
      const uid = cred.user.uid;
      currentUserId = uid;

      get(ref(db, "managers/" + uid)).then(snap => {
        if (snap.exists()) {
          const data = snap.val();
          schoolLocation = { lat: data.lat, lng: data.lng };
          document.getElementById("schoolTitle").innerText = `المدرسة: ${data.school} | المدير: ${data.name}`;
          loginForm.style.display = "none";
          document.getElementById("managerPage").style.display = "block";
          logoutBtn.style.display = "block";
          loadAttendance();
        } else {
          get(ref(db, "teachers/" + uid)).then(snap => {
            if (snap.exists()) {
              document.getElementById("teacherPage").style.display = "block";
              loginForm.style.display = "none";
              logoutBtn.style.display = "block";
              document.getElementById("teacherNameDisplay").innerText = snap.val().name;
            }
          });
        }
      });
    });
  });

  addTeacherForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = teacherName.value;
    const phone = teacherPhone.value;
    const password = teacherPassword.value;
    const email = phone + "@admin.com";

    createUserWithEmailAndPassword(auth, email, password).then(cred => {
      const uid = cred.user.uid;
      set(ref(db, "teachers/" + uid), {
        name, phone, managerId: currentUserId
      });
      alert("تم إضافة المعلم بنجاح");
      addTeacherForm.reset();
    });
  });

  function loadAttendance() {
    const tableBody = document.querySelector("#reportTable tbody");
    if (!currentUserId) return;

    tableBody.innerHTML = "";
    const dateFilter = document.getElementById("dateFilter");
    const path = "attendance/" + currentUserId;

    onValue(ref(db, path), (snapshot) => {
      tableBody.innerHTML = "";
      snapshot.forEach(child => {
        const data = child.val();
        if (!dateFilter.value || dateFilter.value === data.date) {
          const row = `
            <tr>
              <td>${data.teacher}</td>
              <td>${data.status}</td>
              <td>${data.time}</td>
              <td>${data.date}</td>
              <td>${data.lat.toFixed(4)}, ${data.lng.toFixed(4)}</td>
              <td>${data.distance} م</td>
            </tr>
          `;
          tableBody.innerHTML += row;
        }
      });
    });
  }

  document.getElementById("openAttendanceTableBtn").addEventListener("click", () => {
    document.getElementById("printPage").style.display = "block";
    loadAttendance();
  });

  logoutBtn.addEventListener("click", () => {
    signOut(auth).then(() => {
      loginForm.style.display = "block";
      logoutBtn.style.display = "none";
      document.getElementById("managerPage").style.display = "none";
      document.getElementById("teacherPage").style.display = "none";
      document.getElementById("printPage").style.display = "none";
      alert("تم تسجيل الخروج");
    });
  });
</script>
</body>
</html>
