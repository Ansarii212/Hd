<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>نظام تحضير الموظفين</title>
  <style>
    body { font-family: 'Arial', sans-serif; direction: rtl; background: #f0f0f0; padding: 30px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, button, select { padding: 10px; margin-top: 10px; width: 100%; font-size: 16px; }
    video, canvas { display: block; margin: 10px auto; }
    .hidden { display: none; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  </style>
</head>
<body>
<div class="container">
  <h2>نظام تحضير الموظفين</h2>

  <div id="auth-section">
    <input type="text" id="phone" value="010" placeholder="رقم الجوال">
    <input type="password" id="password" value="admin" placeholder="كلمة المرور">
    <button onclick="login()">تسجيل الدخول</button>
  </div>

  <div id="main-section" class="hidden">
    <h3>مرحباً، <span id="user-role"></span></h3>

    <div id="teacher-section" class="hidden">
      <video id="video" width="300" height="220" autoplay></video>
      <canvas id="canvas" width="300" height="220" class="hidden"></canvas>
      <button onclick="capture('in')">تسجيل الحضور</button>
      <button onclick="capture('out')">تسجيل الانصراف</button>
    </div>

    <div id="admin-section" class="hidden">
      <h4>إنشاء حساب معلم</h4>
      <input type="text" id="new-phone" placeholder="رقم الجوال">
      <input type="password" id="new-pass" placeholder="كلمة المرور">
      <button onclick="register()">إنشاء</button>

      <h4>تقارير الحضور</h4>
      <button onclick="loadReports()">تحميل التقارير</button>
      <button onclick="exportExcel()">تصدير إلى Excel</button>
      <div id="report-section"></div>
    </div>
  </div>
</div>

<!-- Firebase and XLSX -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
    authDomain: "hamsa-6009e.firebaseapp.com",
    databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
    projectId: "hamsa-6009e",
    storageBucket: "hamsa-6009e.appspot.com",
    messagingSenderId: "998163671039",
    appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca",
    measurementId: "G-PD1QB8X0FE"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);
  let currentUser = null;
  let currentRole = null;
  let schoolLocation = null;

  async function login() {
    const phone = document.getElementById("phone").value;
    const password = document.getElementById("password").value;
    const email = `${phone}@app.com`;

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      currentUser = cred.user;

      const userSnap = await get(ref(db, `users/${currentUser.uid}`));
      currentRole = userSnap.exists() ? userSnap.val().role : "admin";

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("main-section").classList.remove("hidden");
      document.getElementById("user-role").innerText = currentRole;

      if (currentRole === 'teacher') {
        document.getElementById("teacher-section").classList.remove("hidden");
        startCamera();
        checkLocation();
      } else {
        document.getElementById("admin-section").classList.remove("hidden");
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          schoolLocation = { latitude, longitude };
          set(ref(db, 'school/location'), schoolLocation);
        });
      }
    } catch (err) {
      alert("فشل تسجيل الدخول: " + err.message);
    }
  }

  async function register() {
    const phone = document.getElementById("new-phone").value;
    const password = document.getElementById("new-pass").value;
    const email = `${phone}@app.com`;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await set(ref(db, `users/${cred.user.uid}`), { role: "teacher", phone });
      alert("تم إنشاء الحساب");
    } catch (err) {
      alert("خطأ: " + err.message);
    }
  }

  function startCamera() {
    const video = document.getElementById("video");
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("فشل تشغيل الكاميرا"));
  }

  async function checkLocation() {
    const schoolSnap = await get(ref(db, 'school/location'));
    if (schoolSnap.exists()) {
      const school = schoolSnap.val();
      navigator.geolocation.getCurrentPosition(pos => {
        const userLoc = pos.coords;
        const dist = distance(userLoc.latitude, userLoc.longitude, school.latitude, school.longitude);
        if (dist > 100) {
          alert(`موقعك بعيد عن المدرسة (${Math.round(dist)} متر)، لم يتم تسجيل الحضور.`);
        }
      });
    }
  }

  function distance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // متر
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function capture(type) {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(async blob => {
      const date = new Date().toISOString().split("T")[0];
      const time = new Date().toLocaleTimeString();
      const path = `attendance/${currentUser.uid}/${date}_${type}.jpg`;
      const fileRef = sRef(storage, path);
      await uploadBytes(fileRef, blob);
      await set(ref(db, `attendance/${currentUser.uid}/${date}_${type}`), { time, path });
      alert(type === 'in' ? "تم تسجيل الحضور" : "تم تسجيل الانصراف");
    }, "image/jpeg");
  }

  async function loadReports() {
    const snap = await get(ref(db, 'attendance'));
    let html = `<table><tr><th>المعلم</th><th>التاريخ</th><th>الحضور</th><th>الانصراف</th></tr>`;
    for (const uid in snap.val()) {
      const userSnap = await get(ref(db, `users/${uid}`));
      const phone = userSnap.exists() ? userSnap.val().phone : "مجهول";
      const days = snap.val()[uid];
      const grouped = {};
      for (const k in days) {
        const [date, type] = k.split('_');
        if (!grouped[date]) grouped[date] = {};
        grouped[date][type] = days[k].time;
      }
      for (const d in grouped) {
        html += `<tr><td>${phone}</td><td>${d}</td><td>${grouped[d].in || '-'}</td><td>${grouped[d].out || '-'}</td></tr>`;
      }
    }
    html += "</table>";
    document.getElementById("report-section").innerHTML = html;
  }

  async function exportExcel() {
    const table = document.querySelector("table");
    if (!table) return alert("لا توجد بيانات");
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "التقارير");
    XLSX.writeFile(wb, "تقرير_الحضور.xlsx");
  }
</script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs" type="module"></script>
</body>
</html>
