<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>نظام تحضير الموظفين</title>
  <style>
    body { font-family: 'Arial', sans-serif; direction: rtl; background: #f0f0f0; padding: 30px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, button, select { padding: 10px; margin-top: 10px; width: 100%; font-size: 16px; }
    video, canvas { display: block; margin: 10px auto; }
    .hidden { display: none; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  </style>
</head>
<body>
<div class="container">
  <h2>نظام تحضير الموظفين</h2>

  <div id="register-section">
    <h4>تسجيل لأول مرة</h4>
    <input type="text" id="reg-phone" placeholder="رقم الجوال">
    <input type="password" id="reg-pass" placeholder="كلمة المرور">
    <button onclick="register()">تسجيل</button>
  </div>

  <div id="auth-section" class="hidden">
    <h4>تسجيل الدخول</h4>
    <input type="text" id="phone" placeholder="رقم الجوال">
    <input type="password" id="password" placeholder="كلمة المرور">
    <button onclick="login()">دخول</button>
  </div>

  <div id="main-section" class="hidden">
    <h3>مرحباً، <span id="user-role"></span></h3>

    <div id="teacher-section" class="hidden">
      <video id="video" width="300" height="220" autoplay></video>
      <canvas id="canvas" width="300" height="220" class="hidden"></canvas>
      <button onclick="capture('in')">تسجيل الحضور</button>
      <button onclick="capture('out')">تسجيل الانصراف</button>
    </div>

    <div id="admin-section" class="hidden">
      <h4>إنشاء حساب معلم</h4>
      <input type="text" id="new-phone" placeholder="رقم الجوال">
      <input type="password" id="new-pass" placeholder="كلمة المرور">
      <button onclick="createTeacher()">إنشاء</button>

      <h4>تقارير الحضور</h4>
      <button onclick="loadReports()">تحميل التقارير</button>
      <div id="report-section"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
    authDomain: "hamsa-6009e.firebaseapp.com",
    databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
    projectId: "hamsa-6009e",
    storageBucket: "hamsa-6009e.appspot.com",
    messagingSenderId: "998163671039",
    appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentRole = null;

  async function register() {
    const phone = document.getElementById("reg-phone").value;
    const password = document.getElementById("reg-pass").value;
    const email = `${phone}@app.com`;

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await set(ref(db, `users/${cred.user.uid}`), { role: "teacher", phone });
      alert("تم التسجيل بنجاح، يمكنك تسجيل الدخول الآن");
      document.getElementById("register-section").classList.add("hidden");
      document.getElementById("auth-section").classList.remove("hidden");
    } catch (error) {
      alert("فشل التسجيل: " + error.message);
    }
  }

  async function login() {
    const phone = document.getElementById("phone").value;
    const password = document.getElementById("password").value;
    const email = `${phone}@app.com`;

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      currentUser = cred.user;

      const userSnap = await get(ref(db, `users/${currentUser.uid}`));
      currentRole = userSnap.val().role;

      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("main-section").classList.remove("hidden");
      document.getElementById("user-role").innerText = currentRole;

      if (currentRole === "teacher") {
        document.getElementById("teacher-section").classList.remove("hidden");
        startCamera();
      } else {
        document.getElementById("admin-section").classList.remove("hidden");
      }
    } catch (error) {
      alert("خطأ في الدخول: " + error.message);
    }
  }

  async function createTeacher() {
    const phone = document.getElementById("new-phone").value;
    const password = document.getElementById("new-pass").value;
    const email = `${phone}@app.com`;

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await set(ref(db, `users/${cred.user.uid}`), { role: "teacher", phone });
      alert("تم إنشاء الحساب بنجاح");
    } catch (error) {
      alert("خطأ في إنشاء الحساب: " + error.message);
    }
  }

  function startCamera() {
    const video = document.getElementById("video");
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(() => alert("فشل تشغيل الكاميرا"));
  }

  function capture(type) {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(async blob => {
      const date = new Date().toISOString().split("T")[0];
      const time = new Date().toLocaleTimeString();
      const imgPath = `attendance/${currentUser.uid}/${date}_${type}.jpg`;
      const fileRef = sRef(storage, imgPath);

      await uploadBytes(fileRef, blob);
      await set(ref(db, `attendance/${currentUser.uid}/${date}_${type}`), { time, imgPath });

      alert(type === 'in' ? "تم تسجيل الحضور" : "تم تسجيل الانصراف");
    }, "image/jpeg");
  }

  async function loadReports() {
    const snapshot = await get(ref(db, 'attendance'));
    let html = `<table><tr><th>رقم المعلم</th><th>التاريخ</th><th>الحضور</th><th>الانصراف</th></tr>`;

    for (const uid in snapshot.val()) {
      const userSnap = await get(ref(db, `users/${uid}`));
      const phone = userSnap.exists() ? userSnap.val().phone : "غير معروف";
      const days = snapshot.val()[uid];

      let row = { date: "", in: "-", out: "-" };

      for (const key in days) {
        const [date, type] = key.split('_');
        row.date = date;
        row[type] = days[key].time;
      }

      html += `<tr><td>${phone}</td><td>${row.date}</td><td>${row.in}</td><td>${row.out}</td></tr>`;
    }

    html += "</table>";
    document.getElementById("report-section").innerHTML = html;
  }
</script>
</body>
</html>
